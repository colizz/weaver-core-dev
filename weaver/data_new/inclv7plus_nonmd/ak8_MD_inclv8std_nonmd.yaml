### use `&`, `|`, `~` for logical operations on numpy arrays
### can use functions from `math`, `np` (numpy), and `ak` in the expression

## == NOTE for non-MD training ==
## should always require event_no%7!=0
selection: >-
    (jet_tightId==1) & (jet_no<2) & (fj_pt>200) & (fj_pt<2500) &
    (
      (event_no%7!=0)
    )
### selection to apply at test time (i.e., when running w/ --predict)
# starting from v8: we have dedicated QCD dataset for test only - they compose of 1/7 full events.
# for QCD: just use 1/2 of events
# for top: we have inference dataset storing event_no%7==0 events, so we do not make selections here
test_time_selection: >-
    (jet_tightId==1) & (jet_no<2) &
    (
      ((sample_isQCD==1) & (event_no%2==0)) |
      (sample_isQCD==0)
    )
new_variables:
    ### [format] name: formula
    ### can use functions from `math`, `np` (numpy), and `ak` in the expression
    # classes for reweighting
    label_Top: ((fj_label >= 0) & (fj_label <= 16))
    label_W: ((fj_label >= 30) & (fj_label <= 31))
    label_Z: ((fj_label >= 37) & (fj_label <= 40))
    label_QCD: (fj_label >= 309) & (fj_label < 314)
    # ordered by pt
    cpfcandlt_index: ak.argsort(cpfcandlt_pt_nopuppi, axis=-1, ascending=False)
    cpfcandlt_pt_log_nopuppi_sort: cpfcandlt_pt_log_nopuppi[cpfcandlt_index]
    cpfcandlt_e_log_nopuppi_sort: cpfcandlt_e_log_nopuppi[cpfcandlt_index]
    cpfcandlt_etarel_sort: cpfcandlt_etarel[cpfcandlt_index]
    cpfcandlt_phirel_sort: cpfcandlt_phirel[cpfcandlt_index]
    cpfcandlt_abseta_sort: cpfcandlt_abseta[cpfcandlt_index]
    cpfcandlt_charge_sort: cpfcandlt_charge[cpfcandlt_index]
    cpfcandlt_isEl_sort: cpfcandlt_isEl[cpfcandlt_index]
    cpfcandlt_isMu_sort: cpfcandlt_isMu[cpfcandlt_index]
    cpfcandlt_isChargedHad_sort: cpfcandlt_isChargedHad[cpfcandlt_index]
    cpfcandlt_isLostTrack_sort: cpfcandlt_isLostTrack[cpfcandlt_index]
    cpfcandlt_VTX_ass_sort: cpfcandlt_VTX_ass[cpfcandlt_index]
    cpfcandlt_lostInnerHits_sort: cpfcandlt_lostInnerHits[cpfcandlt_index]
    cpfcandlt_normchi2_sort: cpfcandlt_normchi2[cpfcandlt_index]
    cpfcandlt_quality_sort: cpfcandlt_quality[cpfcandlt_index]
    cpfcandlt_dz_sort: cpfcandlt_dz[cpfcandlt_index]
    cpfcandlt_dzsig_sort: cpfcandlt_dzsig[cpfcandlt_index]
    cpfcandlt_dxy_sort: cpfcandlt_dxy[cpfcandlt_index]
    cpfcandlt_dxysig_sort: cpfcandlt_dxysig[cpfcandlt_index]
    cpfcandlt_btagEtaRel_sort: cpfcandlt_btagEtaRel[cpfcandlt_index]
    cpfcandlt_btagPtRatio_sort: cpfcandlt_btagPtRatio[cpfcandlt_index]
    cpfcandlt_btagPParRatio_sort: cpfcandlt_btagPParRatio[cpfcandlt_index]
    cpfcandlt_btagSip3dVal_sort: cpfcandlt_btagSip3dVal[cpfcandlt_index]
    cpfcandlt_btagSip3dSig_sort: cpfcandlt_btagSip3dSig[cpfcandlt_index]
    cpfcandlt_btagJetDistVal_sort: cpfcandlt_btagJetDistVal[cpfcandlt_index]
    # cpfcandlt_pixelBarrelLayersWithMeasurement_sort: cpfcandlt_pixelBarrelLayersWithMeasurement[cpfcandlt_index]
    # cpfcandlt_pixelEndcapLayersWithMeasurement_sort: cpfcandlt_pixelEndcapLayersWithMeasurement[cpfcandlt_index]
    # cpfcandlt_stripTECLayersWithMeasurement_sort: cpfcandlt_stripTECLayersWithMeasurement[cpfcandlt_index]
    # cpfcandlt_stripTIBLayersWithMeasurement_sort: cpfcandlt_stripTIBLayersWithMeasurement[cpfcandlt_index]
    # cpfcandlt_stripTIDLayersWithMeasurement_sort: cpfcandlt_stripTIDLayersWithMeasurement[cpfcandlt_index]
    # cpfcandlt_stripTOBLayersWithMeasurement_sort: cpfcandlt_stripTOBLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_px_sort: cpfcandlt_px[cpfcandlt_index]
    cpfcandlt_py_sort: cpfcandlt_py[cpfcandlt_index]
    cpfcandlt_pz_sort: cpfcandlt_pz[cpfcandlt_index]
    cpfcandlt_energy_sort: cpfcandlt_energy[cpfcandlt_index]
    # masks
    cpfcandlt_mask: ak.ones_like(cpfcandlt_etarel)
    npfcand_mask: ak.ones_like(npfcand_etarel)
    sv_mask: ak.ones_like(sv_etarel)
    # jet features
    fj_pt_log: np.log(fj_pt)
    fj_mass_log: np.log(fj_mass)
    fj_energy: ak.sum(cpfcandlt_energy[cpfcandlt_isLostTrack == 0], 1) + ak.sum(npfcand_energy, 1) ##!! temporarily construcing fj_energy by particles; will store fj_energy in the future
    fj_energy_log: np.log(fj_energy)
    # modified label: Top 0-16; W: 30-31; Z: 37-40; QCD: 309-313
    fj_label_nonmd: ak.where(fj_label <= 16, fj_label, ak.where(fj_label <= 31, fj_label - 13, ak.where(fj_label <= 40, fj_label - 18, ak.where(fj_label <= 313, fj_label - 286, -1))))

preprocess:
    ### method: [manual, auto] - whether to use manually specified parameters for variable standardization
    method: manual
    ### data_fraction: fraction of events to use when calculating the mean/scale for the standardization
    data_fraction:

inputs:
    cpf_features:
        length: 90
        pad_mode: wrap
        vars:
            ### [format 1]: var_name (no transformation)
            ### [format 2]: [var_name,
            ###              subtract_by(optional, default=None, no transf. if preprocess.method=manual, auto transf. if preprocess.method=auto),
            ###              multiply_by(optional, default=1),
            ###              clip_min(optional, default=-5),
            ###              clip_max(optional, default=5),
            ###              pad_value(optional, default=0)]
            - [cpfcandlt_pt_log_nopuppi_sort, 1, 0.5]
            - [cpfcandlt_e_log_nopuppi_sort, 1.3, 0.5]
            - cpfcandlt_etarel_sort
            - cpfcandlt_phirel_sort
            - [cpfcandlt_abseta_sort, 0.6, 1.6]
            - cpfcandlt_charge_sort
            - cpfcandlt_isEl_sort
            - cpfcandlt_isMu_sort
            - cpfcandlt_isChargedHad_sort
            - cpfcandlt_isLostTrack_sort
            - [cpfcandlt_VTX_ass_sort, 4, 0.3]
            - cpfcandlt_lostInnerHits_sort
            - [cpfcandlt_normchi2_sort, 5, 0.2]
            - [cpfcandlt_quality_sort, 0, 0.2]
            - [cpfcandlt_dz_sort, 0, 180]
            - [cpfcandlt_dzsig_sort, 0, 0.9]
            - [cpfcandlt_dxy_sort, 0.0, 300]
            - [cpfcandlt_dxysig_sort, 0, 1.0]
            - [cpfcandlt_btagEtaRel_sort, 1.5, 0.5]
            - [cpfcandlt_btagPtRatio_sort, 0, 1]
            - [cpfcandlt_btagPParRatio_sort, 0, 1]
            - [cpfcandlt_btagSip3dVal_sort, 0, 100]
            - [cpfcandlt_btagSip3dSig_sort, 0, 0.5]
            - [cpfcandlt_btagJetDistVal_sort, 0, 40]
            # - [cpfcandlt_pixelBarrelLayersWithMeasurement_sort, 0, 0.1] # these are temporarily not used
            # - [cpfcandlt_pixelEndcapLayersWithMeasurement_sort, 0, 0.1]
            # - [cpfcandlt_stripTECLayersWithMeasurement_sort, 0, 0.1]
            # - [cpfcandlt_stripTIBLayersWithMeasurement_sort, 0, 0.1]
            # - [cpfcandlt_stripTIDLayersWithMeasurement_sort, 0, 0.1]
            # - [cpfcandlt_stripTOBLayersWithMeasurement_sort, 0, 0.1]
    cpf_vectors:
        length: 90
        pad_mode: wrap
        vars:
            - [cpfcandlt_px_sort, null]
            - [cpfcandlt_py_sort, null]
            - [cpfcandlt_pz_sort, null]
            - [cpfcandlt_energy_sort, null]
    cpf_mask:
        length: 90
        pad_mode: constant
        vars:
            - cpfcandlt_mask
    npf_features:
        length: 60
        pad_mode: wrap
        vars:
            - [npfcand_pt_log_nopuppi, 1, 0.5]
            - [npfcand_e_log_nopuppi, 1.3, 0.5]
            - npfcand_etarel
            - npfcand_phirel
            - [npfcand_abseta, 0.6, 1.6]
            - npfcand_isGamma
            - npfcand_isNeutralHad
    npf_vectors:
        length: 60
        pad_mode: wrap
        vars:
            - [npfcand_px, null]
            - [npfcand_py, null]
            - [npfcand_pz, null]
            - [npfcand_energy, null]
    npf_mask:
        length: 60
        pad_mode: constant
        vars:
            - npfcand_mask
    sv_features:
        length: 10
        pad_mode: wrap
        vars:
            - [sv_pt_log, 4, 0.6]
            - [sv_mass, 1.2, 0.3]
            - sv_etarel
            - sv_phirel
            - [sv_abseta, 0.5, 1.6]
            - [sv_ntracks, 3, 1]
            - [sv_normchi2, 0.8, 0.6]
            - [sv_dxy, 0.4, 0.25]
            - [sv_dxysig, 7, 0.02]
            - [sv_d3d, 0.5, 0.2]
            - [sv_d3dsig, 7, 0.02]
    sv_vectors:
        length: 10
        pad_mode: wrap
        vars:
            - [sv_px, null]
            - [sv_py, null]
            - [sv_pz, null]
            - [sv_energy, null]
    sv_mask:
        length: 10
        pad_mode: constant
        vars:
            - sv_mask
    jet_features:
        length: null
        vars:
            - [fj_pt_log, 7., 2.]
            - [fj_mass_log, 5., 0.8]
            # - [fj_energy_log, 7., 2.]
            # - fj_eta

labels:
    ### type can be `simple`, `custom`, 'hybrid'
    type: custom
    value:
      truth_label: fj_label_nonmd  # just input the label index

observers:
    - event_no
    - fj_label
    - fj_pt
    - fj_eta
    - fj_phi
    - fj_mass
    - fj_sdmass
    - fj_sdmass_fromsubjets
    - fj_gen_mass
    - fj_genparts_mass
    - fj_genjet_sdmass
    - fj_genjet_nomu_sdmass
    - sample_isQCD
    - pfParticleNetMassRegressionJetTags_mass
    - pfMassDecorrelatedParticleNetJetTags_probXbb
    - pfMassDecorrelatedParticleNetJetTags_probXcc
    - pfMassDecorrelatedParticleNetJetTags_probXqq
    - pfMassDecorrelatedParticleNetJetTags_probQCDb
    - pfMassDecorrelatedParticleNetJetTags_probQCDbb
    - pfMassDecorrelatedParticleNetJetTags_probQCDc
    - pfMassDecorrelatedParticleNetJetTags_probQCDcc
    - pfMassDecorrelatedParticleNetJetTags_probQCDothers

weights:
    ### [option 1] use precomputed weights stored in the input files
    # use_precomputed_weights: true
    # weight_branches: [weight, class_weight]
    ### [option 2] compute weights on-the-fly using reweighting histograms
    use_precomputed_weights: false
    reweight_method: flat
    reweight_vars:
        fj_pt: [200, 251, 316, 398, 501, 630, 793, 997, 1255, 1579, 1987, 2500]
        fj_sdmass: [-10000, 10000]
    reweight_classes: [label_Top, label_W, label_Z, label_QCD]
    class_weights: [1, 1, 1, 1]
    reweight_hists:
